{% extends 'base.html' %}

{% block title %}Assembly Engineer Dashboard{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto bg-white p-6 rounded-lg shadow-md">
    <h2 class="text-3xl font-bold mb-6 text-center">Assembly Engineer Dashboard</h2>
    <p class="text-lg mb-4">Welcome, {{ user.username }}! You are logged in as an Assembly Engineer.</p>

    <!-- QR Code Scanner Section -->
    <div class="mb-8">
        <h3 class="text-2xl font-semibold mb-4">Scan QR Code for Actuator Data</h3>
        <div class="flex flex-col md:flex-row gap-4">
            <div class="md:w-1/2">
                <video id="qr-video" class="w-full border rounded-lg" autoplay muted></video>
                <button id="start-scan" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Start Scan</button>
                <button id="stop-scan" class="mt-2 bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 ml-2" disabled>Stop Scan</button>
            </div>
            <div class="md:w-1/2">
                <p id="scan-status" class="text-sm text-gray-600">Click "Start Scan" to begin scanning QR codes.</p>
            </div>
        </div>
    </div>

    <!-- Actuator Data Form -->
    <form id="actuator-form" method="post" class="mb-8">
        {% csrf_token %}
        <h3 class="text-2xl font-semibold mb-4">Actuator Data</h3>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">

            <div>
                <label class="block text-sm font-medium text-gray-700">Sales Order No</label>
                <input id="sales_order_no" name="sales_order_no" readonly class="mt-1 block w-full border-gray-300 rounded-md">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Line Item</label>
                <input id="line_item" name="line_item" readonly class="mt-1 block w-full border-gray-300 rounded-md">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Order No</label>
                <input id="order_no" name="order_no" readonly class="mt-1 block w-full border-gray-300 rounded-md">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Customer</label>
                <input id="customer" name="customer" readonly class="mt-1 block w-full border-gray-300 rounded-md">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Series</label>
                <input id="series" name="series" readonly class="mt-1 block w-full border-gray-300 rounded-md">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Type</label>
                <input id="type" name="type" readonly class="mt-1 block w-full border-gray-300 rounded-md">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Size</label>
                <input id="size" name="size" readonly class="mt-1 block w-full border-gray-300 rounded-md">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Cylinder Size</label>
                <input id="cylinder_size" name="cylinder_size" readonly class="mt-1 block w-full border-gray-300 rounded-md">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Spring Size</label>
                <input id="spring_size" name="spring_size" readonly class="mt-1 block w-full border-gray-300 rounded-md">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">MOC</label>
                <input id="moc" name="moc" readonly class="mt-1 block w-full border-gray-300 rounded-md">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Item Code</label>
                <input id="item_code" name="item_code" readonly class="mt-1 block w-full border-gray-300 rounded-md">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Order Qty</label>
                <input id="order_qty" name="order_qty" readonly class="mt-1 block w-full border-gray-300 rounded-md">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Creation Date</label>
                <input id="creation_date" name="creation_date" readonly class="mt-1 block w-full border-gray-300 rounded-md">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Branch</label>
                <input id="branch" name="branch" readonly class="mt-1 block w-full border-gray-300 rounded-md">
            </div>
        </div>

        <input type="hidden" id="actuator_data" name="actuator_data">
        <button disabled id="submit-btn" class="mt-4 bg-green-500 text-white px-6 py-2 rounded opacity-50">Save Actuator Data</button>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const video = document.getElementById("qr-video");
    const startBtn = document.getElementById("start-scan");
    const stopBtn = document.getElementById("stop-scan");
    const status = document.getElementById("scan-status");
    const actuatorDataInput = document.getElementById("actuator_data");
    const submitBtn = document.getElementById("submit-btn");

    let stream = null;
    let scanning = false;

    startBtn.onclick = startScan;
    stopBtn.onclick = stopScan;

    function startScan() {
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
            .then(s => {
                stream = s;
                video.srcObject = s;
                video.play();
                scanning = true;
                startBtn.disabled = true;
                stopBtn.disabled = false;
                status.textContent = "Scanning...";
                requestAnimationFrame(scanLoop);
            })
            .catch(err => {
                status.textContent = "Camera error. Check permissions.";
                console.error(err);
            });
    }

    function stopScan() {
        scanning = false;
        if (stream) {
            stream.getTracks().forEach(t => t.stop());
        }
        video.srcObject = null;
        startBtn.disabled = false;
        stopBtn.disabled = true;
        status.textContent = "Scan stopped.";
    }

    function scanLoop() {
        if (!scanning) return;

        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

        const result = jsQR(imageData.data, canvas.width, canvas.height);

        if (result) {
            try {
                const data = JSON.parse(result.data);
                fillForm(data);
                actuatorDataInput.value = JSON.stringify(data);
                submitBtn.disabled = false;
                submitBtn.classList.remove("opacity-50");
                status.textContent = "QR scanned & data loaded.";
                stopScan();
                return;
            } catch {
                status.textContent = "QR detected but JSON invalid.";
            }
        }

        requestAnimationFrame(scanLoop);
    }

    function fillForm(d) {
        document.getElementById("sales_order_no").value = d.sales_order_no || "";
        document.getElementById("order_no").value = d.order_no || "";
        document.getElementById("order_qty").value = d.order_qty || "";
        document.getElementById("line_item").value = d.line_item || "";
        document.getElementById("series").value = d.series || "";
        document.getElementById("type").value = d.type || "";
        document.getElementById("size").value = d.size || "";
        document.getElementById("cylinder_size").value = d.cylinder_size || d["cylinder size"] || "";
        document.getElementById("spring_size").value = d.spring_size || d["spring size"] || "";
        document.getElementById("moc").value = d.moc || "";
        document.getElementById("customer").value = d.customer || "";
        document.getElementById("item_code").value = d.item_code || "";
        document.getElementById("creation_date").value = d.creation_date || "";
        document.getElementById("branch").value = d.branch || "";
    }
});
</script>

{% endblock %}

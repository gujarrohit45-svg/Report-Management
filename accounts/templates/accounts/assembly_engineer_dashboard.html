{% extends 'base.html' %}

{% block title %}Assembly Engineer Dashboard{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto bg-white p-6 rounded-lg shadow-md">
    <h2 class="text-3xl font-bold mb-6 text-center">Assembly Engineer Dashboard</h2>
    <p class="text-lg mb-4">Welcome, {{ user.username }}! You are logged in as an Assembly Engineer.</p>

    <!-- QR Code Scanner Section -->
    <div class="mb-8">
        <h3 class="text-2xl font-semibold mb-4">Scan QR Code for Actuator Data</h3>
        <div class="flex flex-col md:flex-row gap-4">
            <div class="md:w-1/2">
                <video id="qr-video" class="w-full border rounded-lg" autoplay muted></video>
                <button id="start-scan" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Start Scan</button>
                <button id="stop-scan" class="mt-2 bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 ml-2" disabled>Stop Scan</button>
            </div>
            <div class="md:w-1/2">
                <p id="scan-status" class="text-sm text-gray-600">Click "Start Scan" to begin scanning QR codes.</p>
            </div>
        </div>
    </div>

    <!-- Actuator Data Form -->
    <form id="actuator-form" method="post" class="mb-8">
        {% csrf_token %}
        <h3 class="text-2xl font-semibold mb-4">Actuator Data</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div>
                <label for="sales_order_no" class="block text-sm font-medium text-gray-700">Sales Order No</label>
                <input type="text" id="sales_order_no" name="sales_order_no" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" readonly>
            </div>
            <div>
                <label for="line_item" class="block text-sm font-medium text-gray-700">Line Item</label>
                <input type="text" id="line_item" name="line_item" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" readonly>
            </div>
            <div>
                <label for="order_no" class="block text-sm font-medium text-gray-700">Order No</label>
                <input type="text" id="order_no" name="order_no" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" readonly>
            </div>
            <div>
                <label for="customer" class="block text-sm font-medium text-gray-700">Customer</label>
                <input type="text" id="customer" name="customer" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" readonly>
            </div>

            <div>
                <label for="series" class="block text-sm font-medium text-gray-700">Series</label>
                <input type="text" id="series" name="series" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" readonly>
            </div>
            <div>
                <label for="type" class="block text-sm font-medium text-gray-700">Type</label>
                <input type="text" id="type" name="type" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" readonly>
            </div>
            <div>
                <label for="size" class="block text-sm font-medium text-gray-700">Size</label>
                <input type="text" id="size" name="size" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" readonly>
            </div>
            <div>
                <label for="cylinder_size" class="block text-sm font-medium text-gray-700">Cylinder Size (inch)</label>
                <input type="text" id="cylinder_size" name="cylinder_size" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" readonly>
            </div>
            <div>
                <label for="spring_size" class="block text-sm font-medium text-gray-700">Spring Size</label>
                <input type="text" id="spring_size" name="spring_size" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" readonly>
            </div>
            <div>
                <label for="moc" class="block text-sm font-medium text-gray-700">MOC</label>
                <input type="text" id="moc" name="moc" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" readonly>
            </div>
            <div>
                <label for="item_code" class="block text-sm font-medium text-gray-700">Item Code</label>
                <input type="text" id="item_code" name="item_code" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" readonly>
            </div>
            <div>
                <label for="order_qty" class="block text-sm font-medium text-gray-700">Order Quantity</label>
                <input type="text" id="order_qty" name="order_qty" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" readonly>
            </div>
            <div>
                <label for="creation_date" class="block text-sm font-medium text-gray-700">Creation Date</label>
                <input type="text" id="creation_date" name="creation_date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" readonly>
            </div>
            <div>
                <label for="branch" class="block text-sm font-medium text-gray-700">Branch</label>
                <input type="text" id="branch" name="branch" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" readonly>
            </div>
        </div>
        <input type="hidden" id="actuator_data" name="actuator_data">
        <button type="submit" id="submit-btn" class="mt-4 bg-green-500 text-white px-6 py-2 rounded hover:bg-green-600 disabled:opacity-50" disabled>Save Actuator Data</button>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const video = document.getElementById('qr-video');
    const startScanBtn = document.getElementById('start-scan');
    const stopScanBtn = document.getElementById('stop-scan');
    const scanStatus = document.getElementById('scan-status');
    const actuatorForm = document.getElementById('actuator-form');
    const actuatorDataInput = document.getElementById('actuator_data');
    const submitBtn = document.getElementById('submit-btn');
    let stream = null;
    let scanning = false;

    startScanBtn.addEventListener('click', startScanning);
    stopScanBtn.addEventListener('click', stopScanning);

    function startScanning() {
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
            .then(function(mediaStream) {
                stream = mediaStream;
                video.srcObject = stream;
                video.play();
                scanning = true;
                startScanBtn.disabled = true;
                stopScanBtn.disabled = false;
                scanStatus.textContent = 'Scanning for QR code...';
                scanQRCode();
            })
            .catch(function(err) {
                console.error('Error accessing camera:', err);
                scanStatus.textContent = 'Error accessing camera. Please check permissions.';
            });
    }

    function stopScanning() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
        video.srcObject = null;
        scanning = false;
        startScanBtn.disabled = false;
        stopScanBtn.disabled = true;
        scanStatus.textContent = 'Scan stopped.';
    }

    function scanQRCode() {
        if (!scanning) return;

        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);

        if (code) {
            try {
                const data = JSON.parse(code.data);
                populateForm(data);
                actuatorDataInput.value = JSON.stringify(data);
                submitBtn.disabled = false;
                scanStatus.textContent = 'QR code scanned successfully! Data populated in form.';
                stopScanning();
            } catch (e) {
                scanStatus.textContent = 'QR code detected but invalid JSON data.';
            }
        } else {
            requestAnimationFrame(scanQRCode);
        }
    }

    // Simulate scan button to use hardcoded data
    const simulateScanBtn = document.createElement('button');
    simulateScanBtn.textContent = 'Simulate Scan (Use Hardcoded Data)';
    simulateScanBtn.className = 'mt-2 bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600';
    simulateScanBtn.addEventListener('click', function() {
        const data = {
                "sr_no": "001",
                "sales_order_no":"20011793",
                "order_no": "21002715",
                "order_qty": "10",
                "line_item": "30",
                "series": "25",
                "type": "DA",
                "size": "250",
                "cylinder size": "007",
                "spring size": "",
                "moc": "CS",
                "customer": "Japro Eng",
                "item_code": "ACT5588",
                "creation_date": "2025-10-30",
                "branch": "Pune"
                }
        populateForm(data);
        actuatorDataInput.value = JSON.stringify(data);
        submitBtn.disabled = false;
        scanStatus.textContent = 'Simulated scan completed! Data populated in form.';
    });
    document.querySelector('.md\\:w-1\\/2').appendChild(simulateScanBtn);

    function populateForm(data) {
        document.getElementById('order_no').value = data.order_no || '';
        document.getElementById('sales_order_no').value = data.sales_order_no || '';
        document.getElementById('order_qty').value = data.order_qty || '';
        document.getElementById('line_item').value = data.line_item || '';
        document.getElementById('series').value = data.series || '';
        document.getElementById('type').value = data.type || '';
        document.getElementById('size').value = data.size || '';
        document.getElementById('cylinder_size').value = data['cylinder size'] || '';
        document.getElementById('spring_size').value = data['spring size'] || '';
        document.getElementById('moc').value = data.moc || '';
        document.getElementById('customer').value = data.customer || '';
        document.getElementById('item_code').value = data.item_code || '';
        document.getElementById('creation_date').value = data.creation_date || '';
        document.getElementById('branch').value = data.branch || '';
    }
});
</script>
{% endblock %}

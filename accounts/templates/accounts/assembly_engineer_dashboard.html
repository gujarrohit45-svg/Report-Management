{% extends 'base.html' %}

{% block title %}Assembly Engineer Dashboard{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto bg-white p-6 rounded-lg shadow-md">
    <h2 class="text-3xl font-bold mb-6 text-center">Assembly Engineer Dashboard</h2>
    <p class="text-lg mb-4">Welcome, {{ user.username }}! You are logged in as an Assembly Engineer.</p>

    <div class="mb-8">
        <h3 class="text-2xl font-semibold mb-4">Scan QR Code for Actuator Data</h3>

        <div class="flex flex-col md:flex-row gap-4">
            <div class="md:w-1/2">
                <video id="qr-video" class="w-full border rounded-lg" autoplay muted playsinline></video>
                <div class="mt-2">
                    <button id="start-scan" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Start Scan</button>
                    <button id="stop-scan" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 ml-2" disabled>Stop Scan</button>
                    </div>
                <p id="scan-status" class="text-sm text-gray-600 mt-2">Enter data below or click "Start Scan" to scan a QR code.</p>
            </div>

            <div class="md:w-1/2">
                <p class="text-sm text-gray-700">All fields are editable. You can either type the values directly or scan a QR code (JSON payload) to populate them.</p>
                <small class="text-xs text-gray-500">Expected QR JSON keys (example): sales_order_no, order_no, order_qty, line_item, series, type, size, cylinder_size, spring_size, moc, customer, item_code, creation_date, branch</small>
            </div>
        </div>
    </div>

    <form id="actuator-form" method="post" class="mb-8">
        {% csrf_token %}
        <h3 class="text-2xl font-semibold mb-4">Actuator Data</h3>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">

            <div>
                <label class="block text-sm font-medium text-gray-700">Sales Order No</label>
                <input id="sales_order_no" name="sales_order_no" class="mt-1 block w-full border-gray-300 rounded-md focus:bg-white">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Line Item</label>
                <input id="line_item" name="line_item" class="mt-1 block w-full border-gray-300 rounded-md focus:bg-white">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Order No</label>
                <input id="order_no" name="order_no" class="mt-1 block w-full border-gray-300 rounded-md focus:bg-white">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Customer</label>
                <input id="customer" name="customer" class="mt-1 block w-full border-gray-300 rounded-md focus:bg-white">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Series</label>
                <input id="series" name="series" class="mt-1 block w-full border-gray-300 rounded-md focus:bg-white">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Type</label>
                <input id="type" name="type" class="mt-1 block w-full border-gray-300 rounded-md focus:bg-white">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Size</label>
                <input id="size" name="size" class="mt-1 block w-full border-gray-300 rounded-md focus:bg-white">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Cylinder Size</label>
                <input id="cylinder_size" name="cylinder_size" class="mt-1 block w-full border-gray-300 rounded-md focus:bg-white">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Spring Size</label>
                <input id="spring_size" name="spring_size" class="mt-1 block w-full border-gray-300 rounded-md focus:bg-white">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">MOC</label>
                <input id="moc" name="moc" class="mt-1 block w-full border-gray-300 rounded-md focus:bg-white">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Item Code</label>
                <input id="item_code" name="item_code" class="mt-1 block w-full border-gray-300 rounded-md focus:bg-white">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Order Qty</label>
                <input id="order_qty" name="order_qty" class="mt-1 block w-full border-gray-300 rounded-md focus:bg-white">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Creation Date</label>
                <input id="creation_date" name="creation_date" class="mt-1 block w-full border-gray-300 rounded-md focus:bg-white">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Branch</label>
                <input id="branch" name="branch" class="mt-1 block w-full border-gray-300 rounded-md focus:bg-white">
            </div>
        </div>

        <input type="hidden" id="actuator_data" name="actuator_data">
        <div class="mt-4">
            <button id="submit-btn" disabled class="bg-green-500 text-white px-6 py-2 rounded opacity-50">Save Actuator Data</button>
            <button id="clear-btn" type="button" class="ml-2 bg-gray-300 text-black px-4 py-2 rounded">Clear</button>
        </div>
    </form>
</div>

<script src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // Worker path (required by qr-scanner)
    QrScanner.WORKER_PATH = 'https://unpkg.com/qr-scanner@1.4.2/qr-scanner-worker.min.js';

    const video = document.getElementById("qr-video");
    const startBtn = document.getElementById("start-scan");
    const stopBtn = document.getElementById("stop-scan");
    const status = document.getElementById("scan-status");
    const actuatorDataInput = document.getElementById("actuator_data");
    const submitBtn = document.getElementById("submit-btn");
    const clearBtn = document.getElementById("clear-btn");

    const fields = [
        "sales_order_no","line_item","order_no","customer","series","type",
        "size","cylinder_size","spring_size","moc","item_code","order_qty",
        "creation_date","branch"
    ];

    let qrScanner = null;
 
    // enable submit when form changed (manual or from QR)
    function enableSubmitIfValid() {
        // we require order_no and sales_order_no minimally
        const orderNo = document.getElementById("order_no").value.trim();
        const sales = document.getElementById("sales_order_no").value.trim();

        if (orderNo && sales) {
            submitBtn.disabled = false;
            submitBtn.classList.remove("opacity-50");
        } else {
            submitBtn.disabled = true;
            submitBtn.classList.add("opacity-50");
        }
    }

    // attach change listeners for manual edits
    // This now works all the time
    fields.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener("input", () => {
                // build hidden json from fields so server receives data when submitting
                const d = {};
                fields.forEach(fid => { d[fid] = document.getElementById(fid).value || "" });
                actuatorDataInput.value = JSON.stringify(d);
                enableSubmitIfValid();
            });
        }
    });

    clearBtn.addEventListener("click", () => {
        fields.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = "";
        });
        actuatorDataInput.value = "";
        enableSubmitIfValid();
        status.textContent = "Form cleared.";
        // Also reset scanner buttons if scanner was stopped
        startBtn.disabled = false;
        stopBtn.disabled = true;
    });

    // Start scanning
    startBtn.addEventListener("click", async () => {
        startBtn.disabled = true;
        stopBtn.disabled = false;
        status.textContent = "Starting scanner...";

        // If already created, destroy and recreate to avoid multiple instances
        if (qrScanner) {
            try { qrScanner.stop(); qrScanner.destroy(); } catch(e){}
            qrScanner = null;
        }

        // *** FIXED LOGIC: Initialize QrScanner first ***
        qrScanner = new QrScanner(
            video,
            result => {
                // Called when a QR code is detected.
                try {
                    // sometimes libraries return an object with data
                    const text = (typeof result === "string") ? result : (result.data || result);
                    let dataObj = null;
                    try {
                        dataObj = JSON.parse(text);
                    } catch (jsonErr) {
                        // Not JSON - ignore but show content
                        status.textContent = "QR detected, but payload is not JSON.";
                        return;
                    }

                    fillForm(dataObj);
                    actuatorDataInput.value = JSON.stringify(dataObj);
                    enableSubmitIfValid(); // This is still needed!

                    status.textContent = "QR scanned successfully!";
                    // stop after successful scan
                    try { qrScanner.stop(); qrScanner.destroy(); } catch(e){}
                    qrScanner = null;
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                } catch (e) {
                    console.error("Scan handler error:", e);
                    status.textContent = "Error processing QR.";
                }
            },
            {
                // options
                returnDetailedScanResult: false,
                highlightScanRegion: true,
                preferredCamera: 'environment', // Ask for back camera
            }
        );

        // *** FIXED LOGIC: Start scanner and catch errors directly ***
        try {
            await qrScanner.start();
            status.textContent = "Scanning... (point camera at the QR)";
        } catch (e) {
            console.error("Scanner start error:", e);
            // This will now catch "no camera" errors
            status.textContent = "Failed to start scanner. (No camera found or permission denied)";
            startBtn.disabled = false;
            stopBtn.disabled = true;
            if (qrScanner) {
                try { qrScanner.destroy(); } catch (e) {}
                qrScanner = null;
            }
        }
    });

    // Stop scanning
    stopBtn.addEventListener("click", () => {
        if (qrScanner) {
            try {
                qrScanner.stop();
                qrScanner.destroy();
            } catch(e){
                console.warn("Scanner cleanup failed", e);
            }
            qrScanner = null;
        }

        startBtn.disabled = false;
        stopBtn.disabled = true;
        status.textContent = "Scanner stopped.";
    });

    // fill form helper
    function fillForm(d) {
        // Support different key naming (snake_case or spaces)
        function v(key) {
            if (d[key] !== undefined) return d[key];
            // fallback variants
            const alt = key.replace("_", " ");
            if (d[alt] !== undefined) return d[alt];
            const alt2 = key.replace("_", "");
            if (d[alt2] !== undefined) return d[alt2];
            return "";
        }

        const mapping = {
            sales_order_no: v("sales_order_no"),
            order_no: v("order_no"),
            order_qty: v("order_qty"),
            line_item: v("line_item"),
            series: v("series"),
            type: v("type"),
            size: v("size"),
            cylinder_size: v("cylinder_size") || v("cylinder size"),
            spring_size: v("spring_size") || v("spring size"),
            moc: v("moc"),
            customer: v("customer"),
            item_code: v("item_code"),
            creation_date: v("creation_date"),
            branch: v("branch")
        };

        Object.keys(mapping).forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = mapping[id] || "";
        });
    }

    // On form submit, ensure hidden actuator_data is set (if manual mode or fields edited)
    document.getElementById("actuator-form").addEventListener("submit", (ev) => {
        // Build object from fields (overwrite hidden if present)
        const d = {};
        fields.forEach(fid => {
            d[fid] = document.getElementById(fid).value || "";
        });
        actuatorDataInput.value = JSON.stringify(d);
        // allow submission to continue to server
    });

});
</script>

{% endblock %}